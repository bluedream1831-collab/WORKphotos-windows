<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¦é ˜è–ªè³‡è¨ˆç®—å™¨ (V13.1)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f2f2f7;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .calculator-container {
            background: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            width: 100%;
            max-width: 480px;
            margin-bottom: 20px;
        }

        h1 {
            color: #007aff;
            text-align: center;
            margin-bottom: 8px;
            font-size: 1.3em;
            margin-top: 0;
        }
        
        .notice-group {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.8em;
        }
        .notice-box {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            line-height: 1.3;
        }
        .privacy { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
        .cycle { background-color: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }

        h2 {
            color: #1c1c1e;
            font-size: 1.1em;
            font-weight: 700;
            margin: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 10px;
            border-bottom: 2px solid #f2f2f7;
            padding-bottom: 5px;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-small {
            border: none;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-clear { background-color: #ff3b30; color: white; }
        .btn-lock { background-color: #e5e5ea; color: #333; }
        .btn-lock.locked { background-color: #34c759; color: white; }

        /* æ ¼ç·šç³»çµ± */
        .grid-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 8px;
        }

        .col-full { flex: 1 1 100%; }
        .col-half { flex: 1 1 45%; }
        .col-third { flex: 1 1 30%; }

        .input-wrapper { display: flex; flex-direction: column; }

        label {
            font-size: 0.85em;
            font-weight: 600;
            color: #555;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rate-badge {
            font-size: 0.75em;
            color: #007aff;
            background-color: #e3f2fd;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 2px;
            font-weight: normal;
        }

        .input-with-unit { display: flex; align-items: center; }

        input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d1d6;
            border-radius: 6px;
            text-align: right;
            font-size: 16px;
            background-color: #fcfcfc;
            color: #333;
        }
        
        input[type="number"]:disabled {
            background-color: #f2f2f7;
            color: #8e8e93;
            border-color: #e5e5ea;
        }
        
        input[type="number"]:focus { border-color: #007aff; outline: none; background-color: #fff; }

        .unit {
            font-size: 0.8em;
            color: #888;
            margin-left: 4px;
            white-space: nowrap;
        }

        .variable-highlight {
            background-color: #fff9c4;
            border: 1px solid #fbc02d !important;
        }
        input[type="number"]:disabled.variable-highlight {
            background-color: #f2f2f7;
            border: 1px solid #e5e5ea !important;
        }

        /* æ‘˜è¦é¢æ¿ */
        .summary-panel {
            background-color: #f0f9ff;
            border: 1px solid #b3e5fc;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        details {
            margin-top: 10px;
            border: 1px solid #e5e5ea;
            border-radius: 8px;
        }
        summary {
            padding: 8px 12px;
            font-size: 0.9em;
            color: #007aff;
            background-color: #f9f9f9;
            cursor: pointer;
            font-weight: 600;
        }
        .details-content { padding: 10px; font-size: 0.85em; color: #555; }
        
        /* çµæœå€ */
        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: #f1f8e9;
            border: 1px solid #c8e6c9;
            border-radius: 10px;
            text-align: center;
        }
        .result-area p {
            font-size: 2.2em;
            font-weight: 800;
            color: #2e7d32;
            margin: 5px 0 10px 0;
        }
        
        .sub-result {
            font-size: 0.9em;
            color: #555;
            display: flex;
            justify-content: space-between;
            padding: 2px 10px;
        }

        .total-hours-tag {
            background: #fff;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            color: #333;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            display: inline-block;
            margin-bottom: 10px;
        }

        .formula-list { padding-left: 20px; margin: 0; }
        .formula-list li { margin-bottom: 5px; }
    </style>
</head>
<body>
    
    <div class="calculator-container">
        <h1>å¯¦é ˜è–ªè³‡è¨ˆç®—å™¨ (V13.1)</h1>
        
        <div class="notice-group">
            <div class="notice-box privacy">
                ğŸ”’ <strong>éš±ç§ä¿è­·</strong><br>è³‡æ–™åƒ…å­˜å€‹äººæ‰‹æ©Ÿ
            </div>
            <div class="notice-box cycle">
                ğŸ“… <strong>è¨ˆè–ªé€±æœŸ</strong><br>ä¸Šæœˆ21-ç•¶æœˆ20
            </div>
        </div>

        <!-- æœˆè–ªè¼¸å…¥å€ (å«é–å®šæŒ‰éˆ•) -->
        <div class="section-header">
            <h2>ğŸ’° æœˆè–ªçµæ§‹</h2>
            <button id="lockBtn" onclick="toggleLock()" class="btn-small btn-lock">ğŸ”“ ç·¨è¼¯æ¨¡å¼</button>
        </div>
        
        <div class="grid-row">
            <div class="col-full input-wrapper">
                <label>æœ¬ä¿¸</label>
                <div class="input-with-unit">
                    <input type="number" id="baseSalary" placeholder="è«‹è¼¸å…¥é‡‘é¡" min="0">
                    <span class="unit">å…ƒ</span>
                </div>
            </div>
        </div>

        <div class="grid-row">
            <div class="col-half input-wrapper">
                <label>ä¼™é£Ÿæ´¥è²¼</label>
                <div class="input-with-unit">
                    <input type="number" id="mealAllowance" value="3000">
                    <span class="unit">å…ƒ</span>
                </div>
            </div>
            <div class="col-half input-wrapper">
                <label>äº¤é€šæ´¥è²¼</label>
                <div class="input-with-unit">
                    <input type="number" id="transportAllowance" value="1000">
                    <span class="unit">å…ƒ</span>
                </div>
            </div>
        </div>

        <div class="grid-row">
            <div class="col-half input-wrapper">
                <label>å†·å‡æ´¥è²¼</label>
                <div class="input-with-unit">
                    <input type="number" id="freezerAllowance" value="4000">
                    <span class="unit">å…ƒ</span>
                </div>
            </div>
            <div class="col-half input-wrapper">
                <label style="color:#f57c00;">ç†è²¨çé‡‘(æµ®å‹•)</label>
                <div class="input-with-unit">
                    <input type="number" id="pickingBonus" value="3000" class="variable-highlight">
                    <span class="unit">å…ƒ</span>
                </div>
            </div>
        </div>

        <div class="summary-panel">
            <div class="summary-row" style="border-bottom:1px dashed #b3e5fc; padding-bottom:4px; margin-bottom:4px;">
                <span>æœˆè–ªç¸½é¡ (æœªæ‰£æ¬¾)</span>
                <span id="displayTotalBase" style="font-weight:bold; color:#0277bd;">0 å…ƒ</span>
            </div>
            <div class="summary-row">
                <span>åŸºç¤æ™‚è–ª (Ã·240)</span>
                <span id="displayHourlyRate" style="font-weight:bold; color:#d32f2f;">0 å…ƒ</span>
            </div>
        </div>
        
        <!-- åŠ ç­æ™‚æ•¸è¼¸å…¥å€ -->
        <div class="section-header">
            <h2>â±ï¸ åŠ ç­æ™‚æ•¸</h2>
            <button onclick="clearHours()" class="btn-small btn-clear">ğŸ—‘ï¸ æ™‚æ•¸æ¸…ç©º</button>
        </div>
        
        <label style="margin-top:5px; color:#007aff; display:block;">ğŸ’¼ å¹³æ—¥åŠ ç­</label>
        <div class="grid-row">
            <div class="col-half input-wrapper">
                <label>å‰2å°æ™‚ <span id="rateLabel_134" class="rate-badge">$0</span></label>
                <div class="input-with-unit">
                    <input type="number" id="normalOT1" placeholder="0">
                    <span class="unit">å°æ™‚</span>
                </div>
            </div>
            <div class="col-half input-wrapper">
                <label>ç¬¬3å°æ™‚èµ· <span id="rateLabel_167" class="rate-badge">$0</span></label>
                <div class="input-with-unit">
                    <input type="number" id="normalOT2" placeholder="0">
                    <span class="unit">å°æ™‚</span>
                </div>
            </div>
        </div>
        
        <label style="margin-top:10px; color:#007aff; display:block;">ğŸ—“ï¸ ä¼‘æ¯æ—¥åŠ ç­</label>
        <div class="grid-row">
            <div class="col-third input-wrapper">
                <label>å‰2å°æ™‚ <span id="rateLabel_dayOff1" class="rate-badge">$0</span></label>
                <div class="input-with-unit">
                    <input type="number" id="dayOffOT1" placeholder="0">
                </div>
            </div>
            <div class="col-third input-wrapper">
                <label>3-8å°æ™‚ <span id="rateLabel_dayOff2" class="rate-badge">$0</span></label>
                <div class="input-with-unit">
                    <input type="number" id="dayOffOT2" placeholder="0">
                </div>
            </div>
            <div class="col-third input-wrapper">
                <label>9å°æ™‚èµ· <span id="rateLabel_dayOff3" class="rate-badge">$0</span></label>
                <div class="input-with-unit">
                    <input type="number" id="dayOffOT3" placeholder="0">
                </div>
            </div>
        </div>
        
        <label style="margin-top:10px; color:#007aff; display:block;">ğŸ‰ ç‰¹æ®Šç‹€æ³ (æ›ä¼‘)</label>
        <div class="grid-row">
            <div class="col-half input-wrapper">
                <label>åœ‹å®šå‡æ—¥</label>
                <div class="input-with-unit">
                    <input type="number" id="holidayOT" placeholder="0">
                    <span class="unit">å°æ™‚</span>
                </div>
                <div style="font-size:0.7em; margin-top:2px;">
                    <input type="checkbox" id="countHolidayInLimit" style="width:auto;"> è¨ˆå…¥46å°æ™‚
                </div>
            </div>
            <div class="col-half input-wrapper">
                <label>å¤©ç½/äº‹è®Š</label>
                <div class="input-with-unit">
                    <input type="number" id="disasterOT" placeholder="0">
                    <span class="unit">å°æ™‚</span>
                </div>
            </div>
        </div>

        <!-- æ‰£æ¬¾é …ç›®å€ (V13.1 æ”¹ç‚ºå…©æ ¼ä¸¦æ’) -->
        <div class="section-header">
            <h2>ğŸ’¸ æ¯æœˆæ‰£æ¬¾</h2>
        </div>
        <div class="grid-row">
            <div class="col-half input-wrapper">
                <label>å‹å¥ä¿è²»</label>
                <div class="input-with-unit">
                    <input type="number" id="laborHealthInsurance" placeholder="0">
                    <span class="unit">å…ƒ</span>
                </div>
            </div>
            <div class="col-half input-wrapper">
                <label>å…¬å¸ç¦å„²</label>
                <div class="input-with-unit">
                    <input type="number" id="welfareFund" placeholder="0">
                    <span class="unit">å…ƒ</span>
                </div>
            </div>
        </div>

        <!-- çµæœé¡¯ç¤º -->
        <div class="result-area">
            <div class="total-hours-tag">
                ç¸½åŠ ç­æ™‚æ•¸ï¼š<span id="totalHoursAll" style="color:#007aff; font-weight:bold;">0</span> å°æ™‚
            </div>
            
            <p id="netPay">0 å…ƒ</p> <!-- å¯¦é ˜é‡‘é¡ -->
            
            <div class="sub-result">
                <span>æ‡‰ç™¼ç¸½é¡(å«åŠ ç­)</span>
                <span id="grossPay" style="color:#007aff;">0</span>
            </div>
            <div class="sub-result">
                <span>æ‰£æ¬¾ç¸½è¨ˆ</span>
                <span id="totalDeduction" style="color:#d32f2f;">- 0</span>
            </div>

            <div id="limitCheck" style="margin-top:10px; font-size:0.9em; border-top:1px dashed #ccc; padding-top:5px;">
                <span id="remainingHours" style="color:#34c759;">46å°æ™‚é¡åº¦å…§</span>
            </div>
        </div>
        
        <!-- å…¬å¼èªªæ˜ (æ”¶åˆ) -->
        <details>
            <summary>ğŸ“˜ è¨ˆç®—å…¬å¼èˆ‡è©³æƒ…</summary>
            <div class="details-content">
                <strong>1. åŸºç¤æ™‚è–ª (æœˆè–ªÃ·240)</strong>
                <p style="margin:5px 0 10px 0; font-size:0.9em;">åŒ…å«æœ¬ä¿¸ã€æ´¥è²¼åŠå›ºå®šçé‡‘ã€‚</p>
                <strong>2. å¯¦é ˜é‡‘é¡è¨ˆç®—</strong>
                <p style="margin:5px 0 10px 0; font-size:0.9em; color:#d32f2f;">(åŸºæœ¬æœˆè–ª + åŠ ç­è²») - (å‹å¥ä¿ + ç¦å„²) = å¯¦é ˜</p>
                <hr style="margin:10px 0; border:0; border-top:1px dashed #ccc;">
                <strong>è©³ç´°ç®—å¼ï¼š</strong>
                <div id="breakdownList" style="margin-top:5px; line-height:1.6;">
                    <!-- JS å‹•æ…‹å¡«å…¥ -->
                </div>
            </div>
        </details>
    </div>

    <script>
        const MULTIPLIERS = {
            RATE_134: 4/3, RATE_167: 5/3, RATE_267: 8/3  
        };

        // V13.1 æ›´æ–°ï¼šåˆä½µå‹å¥ä¿æ¬„ä½
        const salaryInputIds = [
            'baseSalary', 'mealAllowance', 'transportAllowance', 'freezerAllowance', 'pickingBonus',
            'laborHealthInsurance', 'welfareFund' 
        ];

        const hourInputIds = [
            'normalOT1', 'normalOT2', 'dayOffOT1', 'dayOffOT2', 'dayOffOT3', 'holidayOT', 'disasterOT'
        ];

        const allInputIds = [...salaryInputIds, ...hourInputIds];
        const STORAGE_KEY = 'salary_calc_v13_1';

        let isLocked = false;

        function calculate() {
            // A. æœˆè–ª
            const baseSalary = parseFloat(document.getElementById('baseSalary').value) || 0;
            const mealAllowance = parseFloat(document.getElementById('mealAllowance').value) || 0;
            const transportAllowance = parseFloat(document.getElementById('transportAllowance').value) || 0;
            const freezerAllowance = parseFloat(document.getElementById('freezerAllowance').value) || 0;
            const pickingBonus = parseFloat(document.getElementById('pickingBonus').value) || 0;
            const monthlyBase = Math.round(baseSalary + mealAllowance + transportAllowance + freezerAllowance + pickingBonus);

            // B. è²»ç‡
            const hourlyRateRaw = monthlyBase / 240;
            const r134 = Math.round(hourlyRateRaw * MULTIPLIERS.RATE_134);
            const r167 = Math.round(hourlyRateRaw * MULTIPLIERS.RATE_167);
            const r267 = Math.round(hourlyRateRaw * MULTIPLIERS.RATE_267);

            document.getElementById('displayTotalBase').innerText = `${monthlyBase.toLocaleString()}`;
            document.getElementById('displayHourlyRate').innerText = `${hourlyRateRaw.toFixed(1)}`;
            
            document.getElementById('rateLabel_134').innerText = `$${r134}`;
            document.getElementById('rateLabel_167').innerText = `$${r167}`;
            document.getElementById('rateLabel_dayOff1').innerText = `$${r134}`;
            document.getElementById('rateLabel_dayOff2').innerText = `$${r167}`;
            document.getElementById('rateLabel_dayOff3').innerText = `$${r267}`;

            // C. æ™‚æ•¸ & åŠ ç­è²»
            const n1 = parseFloat(document.getElementById('normalOT1').value) || 0;
            const n2 = parseFloat(document.getElementById('normalOT2').value) || 0;
            const d1 = parseFloat(document.getElementById('dayOffOT1').value) || 0;
            const d2 = parseFloat(document.getElementById('dayOffOT2').value) || 0;
            const d3 = parseFloat(document.getElementById('dayOffOT3').value) || 0;
            const hol = parseFloat(document.getElementById('holidayOT').value) || 0; 
            const dis = parseFloat(document.getElementById('disasterOT').value) || 0;

            const totalHours = n1 + n2 + d1 + d2 + d3 + hol + dis;
            document.getElementById('totalHoursAll').innerText = totalHours.toFixed(1);

            const p_n1 = n1 * r134;
            const p_n2 = n2 * r167;
            const p_d1 = d1 * r134;
            const p_d2 = d2 * r167;
            const p_d3 = d3 * r267;
            const totalOTPay = Math.round(p_n1 + p_n2 + p_d1 + p_d2 + p_d3);

            // D. æ‰£æ¬¾è¨ˆç®— (V13.1 æ›´æ–°)
            const laborHealth = parseFloat(document.getElementById('laborHealthInsurance').value) || 0;
            const welfare = parseFloat(document.getElementById('welfareFund').value) || 0;
            const totalDeduction = Math.round(laborHealth + welfare);

            // E. ç¸½çµ
            const grossPay = monthlyBase + totalOTPay; // æ‡‰ç™¼ç¸½é¡
            const netPay = grossPay - totalDeduction;  // å¯¦é ˜é‡‘é¡

            document.getElementById('grossPay').innerText = grossPay.toLocaleString();
            document.getElementById('totalDeduction').innerText = `- ${totalDeduction.toLocaleString()}`;
            document.getElementById('netPay').innerText = `${netPay.toLocaleString()} å…ƒ`;

            // è©³ç´°ç®—å¼
            let breakdownHtml = '';
            if(n1>0) breakdownHtml += `å¹³æ—¥å‰2å°æ™‚: ${n1}Ã—$${r134} = $${p_n1}<br>`;
            if(n2>0) breakdownHtml += `å¹³æ—¥å¾ŒçºŒ: ${n2}Ã—$${r167} = $${p_n2}<br>`;
            if(d1>0) breakdownHtml += `ä¼‘æ¯æ—¥å‰2å°æ™‚: ${d1}Ã—$${r134} = $${p_d1}<br>`;
            if(d2>0) breakdownHtml += `ä¼‘æ¯æ—¥3-8å°æ™‚: ${d2}Ã—$${r167} = $${p_d2}<br>`;
            if(d3>0) breakdownHtml += `ä¼‘æ¯æ—¥9å°æ™‚èµ·: ${d3}Ã—$${r267} = $${p_d3}<br>`;
            
            breakdownHtml += `<hr style="margin:5px 0; border:0; border-top:1px dashed #ccc;">`;
            breakdownHtml += `æœˆè–ª: ${monthlyBase.toLocaleString()}<br>`;
            breakdownHtml += `åŠ ç­è²»: ${totalOTPay.toLocaleString()}<br>`;
            breakdownHtml += `æ‰£æ¬¾: -${totalDeduction.toLocaleString()}<br>`;
            breakdownHtml += `<strong>å¯¦é ˜: $${netPay.toLocaleString()}</strong>`;
            
            document.getElementById('breakdownList').innerHTML = breakdownHtml;

            checkLimit(n1, n2, d1, d2, d3, hol);
            saveData();
        }

        function checkLimit(n1, n2, d1, d2, d3, hol) {
            let limited = n1 + n2 + d1 + d2 + d3;
            if(document.getElementById('countHolidayInLimit').checked) limited += hol;
            
            const remaining = 46 - limited;
            const el = document.getElementById('remainingHours');
            
            if (remaining >= 0) {
                el.innerText = `å‰©é¤˜å—é™æ™‚æ•¸ï¼š${remaining.toFixed(1)} å°æ™‚`;
                el.style.color = '#34c759';
            } else {
                el.innerText = `âš ï¸ å·²è¶…é¡ ${(Math.abs(remaining)).toFixed(1)} å°æ™‚`;
                el.style.color = '#ff3b30';
                el.style.fontWeight = 'bold';
            }
        }

        function clearHours() {
            if (confirm("ç¢ºå®šæ¸…ç©ºæ™‚æ•¸ï¼Ÿ")) {
                hourInputIds.forEach(id => document.getElementById(id).value = '');
                calculate();
            }
        }

        function toggleLock() {
            isLocked = !isLocked;
            updateLockState();
            saveData();
        }

        function updateLockState() {
            const lockBtn = document.getElementById('lockBtn');
            if (isLocked) {
                lockBtn.innerText = "ğŸ”’ å·²é–å®š";
                lockBtn.classList.add("locked");
                salaryInputIds.forEach(id => document.getElementById(id).disabled = true);
            } else {
                lockBtn.innerText = "ğŸ”“ ç·¨è¼¯æ¨¡å¼";
                lockBtn.classList.remove("locked");
                salaryInputIds.forEach(id => document.getElementById(id).disabled = false);
            }
        }

        function saveData() {
            const data = {};
            allInputIds.forEach(id => data[id] = document.getElementById(id).value);
            data['countHolidayInLimit'] = document.getElementById('countHolidayInLimit').checked;
            data['isLocked'] = isLocked;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                const data = JSON.parse(savedData);
                allInputIds.forEach(id => {
                    if (data[id] !== undefined && data[id] !== "") document.getElementById(id).value = data[id];
                });
                if (data['countHolidayInLimit'] !== undefined) {
                    document.getElementById('countHolidayInLimit').checked = data['countHolidayInLimit'];
                }
                if (data['isLocked'] !== undefined) {
                    isLocked = data['isLocked'];
                }
            }
            updateLockState();
        }

        allInputIds.forEach(id => document.getElementById(id).addEventListener('input', calculate));
        document.getElementById('countHolidayInLimit').addEventListener('change', calculate);

        window.onload = function() { loadData(); calculate(); };
    </script>
</body>
</html>
